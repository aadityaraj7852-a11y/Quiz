<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8">
<title>MCQ Maker (Hindi-English + Edit + Translate)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  body{font-family:Arial,sans-serif;margin:20px;background:#f5f5f5;color:#333}
  h2{margin:0 0 10px;font-size:24px}
  .wrap{display:flex;gap:20px;flex-wrap:wrap}
  .col{flex:1;min-width:340px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  input,textarea,select,button{font-size:15px;font-family:inherit}
  input,textarea,select{width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:8px;box-sizing:border-box}
  button{padding:10px 16px;margin:6px 4px;border:none;border-radius:8px;cursor:pointer;transition:0.2s}
  .btn-green{background:#27ae60;color:#fff}
  .btn-green:hover{background:#1e8449}
  .btn-blue{background:#2980b9;color:#fff}
  .btn-blue:hover{background:#1f6391}
  .btn-red{background:#c0392b;color:#fff}
  .btn-red:hover{background:#a93226}
  .btn-orange{background:#e67e22;color:#fff}
  .btn-orange:hover{background:#d35400}
  .btn-gray{background:#7f8c8d;color:#fff}
  .btn-gray:hover{background:#6c757d}
  .btn-small{padding:6px 10px;font-size:13px}
  .preview-table{width:100%;border-collapse:collapse;margin:20px 0;border:3px solid #2c3e50;background:#fff}
  .preview-table td{border:1px solid #7f8c8d;padding:12px;vertical-align:top}
  .preview-table td:first-child{width:140px;font-weight:bold;background:#ecf0f1;color:#2c3e50}
  .img-preview{max-width:260px;display:block;margin-top:10px;border:2px solid #bdc3c7;border-radius:6px}
  .actions{text-align:right;padding:10px 0}
  .actions button{margin:0 5px;padding:9px 12px;font-size:18px}
  .muted{color:#95a5a6;font-size:14px}
</style>
</head>
<body>

<h2><i class="fas fa-file-alt"></i> MCQ → question.docx (हिंदी + English)</h2>
<p class="muted">इमेज सपोर्ट • ऑटोसेव • Google Translate • Edit/Delete/Undo</p>

<div class="wrap">
  <!-- ========== INPUT FORM ========== -->
  <div class="col" style="max-width:680px">
    <label><i class="fas fa-book"></i> Module</label>
    <input id="module" placeholder="जैसे: Physics, Hindi Medium, etc.">

    <label><i class="fas fa-question"></i> Question</label>
    <textarea id="question" rows="4" placeholder="प्रश्न लिखें..."></textarea>
    <label>Question Image</label><input type="file" accept="image/*" id="questionImg">

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
      <div><label>A</label><input id="optA" placeholder="विकल्प A"></div>
      <div><label>B</label><input id="optB" placeholder="विकल्प B"></div>
      <div><label>C</label><input id="optC" placeholder="विकल्प C"></div>
      <div><label>D</label><input id="optD" placeholder="विकल्प D"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px">
      <div><label>Image A</label><input type="file" accept="image/*" id="imgA"></div>
      <div><label>Image B</label><input type="file" accept="image/*" id="imgB"></div>
      <div><label>Image C</label><input type="file" accept="image/*" id="imgC"></div>
      <div><label>Image D</label><input type="file" accept="image/*" id="imgD"></div>
    </div>

    <label><i class="fas fa-check"></i> Answer (A/B/C/D)</label>
    <input id="answer" placeholder="A">

    <label><i class="fas fa-lightbulb"></i> Solution</label>
    <textarea id="solution" rows="3"></textarea>
    <label>Solution Image</label><input type="file" accept="image/*" id="solutionImg">

    <div style="display:flex;gap:15px">
      <div style="flex:1"><label>Positive Marks</label><input id="pm" value="1"></div>
      <div style="flex:1"><label>Negative Marks</label><input id="nm" value="0"></div>
    </div>

    <div style="margin-top:20px;display:flex;flex-wrap:wrap;gap:10px;align-items:center">
      <button id="addBtn" class="btn-green"><i class="fas fa-plus"></i> Add Question</button>
      <button id="translateBtn" class="btn-orange"><i class="fas fa-language"></i> Translate HI ↔ EN</button>
      <button id="clearBtn" class="btn-gray btn-small"><i class="fas fa-broom"></i> Clear Form</button>
      <button id="exportJson" class="btn-gray btn-small"><i class="fas fa-download"></i> Export JSON</button>
    </div>

    <hr>
    <label>JSON Import</label>
    <textarea id="jsonArea" style="height:100px;font-family:monospace"></textarea>
    <div>
      <button id="importBtn" class="btn-blue"><i class="fas fa-upload"></i> Import JSON</button>
      <button id="clearJson" class="btn-gray btn-small"><i class="fas fa-trash"></i> Clear</button>
    </div>

    <hr>
    <button id="exportBtn" class="btn-blue" style="width:100%;padding:14px;font-size:16px">
      <i class="fas fa-file-word"></i> Export question.docx (Word में खोलें)
    </button>
  </div>

  <!-- ========== PREVIEW ========== -->
  <div class="col">
    <h3><i class="fas fa-eye"></i> Preview</h3>
    <div id="previewArea" class="muted">कोई प्रश्न नहीं जोड़ा गया।</div>

    <div style="margin-top:20px">
      <button id="undoBtn" class="btn-gray" title="Undo Delete"><i class="fas fa-undo"></i> Undo Last Delete</button>
      <button id="resetAll" class="btn-red"><i class="fas fa-trash-alt"></i> Clear All</button>
    </div>
  </div>
</div>

<script>
// ==================== Google Translate (Free API) ====================
async function translateText(text, target = 'en') {
  if (!text.trim()) return text;
  const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=\( {target}&dt=t&q= \){encodeURIComponent(text)}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    return data[0].map(x => x[0]).join('');
  } catch (e) {
    alert("Translation failed: " + e.message);
    return text;
  }
}

// ==================== State & Autosave ====================
const STORAGE_KEY = "mcq_maker_v3";
let questions = [];
let qno = 1;
let lastDeleted = null;

function loadState() {
  try {
    const s = localStorage.getItem(STORAGE_KEY);
    if (s) {
      const obj = JSON.parse(s);
      questions = obj.questions || [];
      qno = obj.qno || 1;
      renderPreview();
    }
  } catch (e) { console.warn(e); }
}
function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({questions, qno}));
}
loadState();

// ==================== Helpers ====================
function $(id) { return document.getElementById(id); }
function getVal(id) { return $(id).value.trim(); }
function setVal(id, v) { $(id).value = v || ''; }
function isHindi(text) { return /[\u0900-\u097F]/.test(text || ''); }

function readFile(input) {
  return new Promise(res => {
    const f = input.files && input.files[0];
    if (!f) return res(null);
    const r = new FileReader();
    r.onload = () => res({name: f.name, type: f.type, dataURL: r.result});
    r.readAsDataURL(f);
  });
}

function clearForm(all = true) {
  if (all) setVal('module', '');
  setVal('question', ''); $('questionImg').value = '';
  ['optA','optB','optC','optD'].forEach(id => { setVal(id,''); \( (`img \){id.charAt(id.length-1)}`).value = ''; });
  setVal('answer', ''); setVal('solution', ''); $('solutionImg').value = '';
  setVal('pm', '1'); setVal('nm', '0');
}

// ==================== Translate Button ====================
$('translateBtn').onclick = async () => {
  const module = getVal('module').toLowerCase();
  if (module.includes('hindi') || module.includes('हिंदी')) {
    alert("Module में 'Hindi' है → अनुवाद नहीं किया गया");
    return;
  }

  const fields = ['question','optA','optB','optC','optD','solution'];
  const hasHindi = fields.some(f => isHindi(getVal(f)));
  const target = hasHindi ? 'en' : 'hi';

  for (const f of fields) {
    const txt = getVal(f);
    if (txt) setVal(f, await translateText(txt, target));
  }
  alert(`सब कुछ ${target === 'hi' ? 'हिंदी' : 'English'} में बदल दिया गया!`);
};

// ==================== Add Question ====================
$('addBtn').onclick = async () => {
  const qtext = getVal('question');
  if (!qtext) { alert("प्रश्न लिखो!"); return; }

  const qImg = await readFile($('questionImg'));
  const optImgs = await Promise.all(['A','B','C','D'].map(ch => readFile(\( (`img \){ch}`))));
  const solImg = await readFile($('solutionImg'));

  const item = {
    module: getVal('module') || 'General',
    questionno: qno++,
    question: qtext,
    questionImg: qImg,
    option: [getVal('optA'), getVal('optB'), getVal('optC'), getVal('optD')],
    optionImg: optImgs,
    answer: getVal('answer').toUpperCase(),
    solution: getVal('solution'),
    solutionImg: solImg,
    pm: getVal('pm') || '1',
    nm: getVal('nm') || '0',
    language: isHindi(qtext) ? 'hi' : 'en'
  };

  questions.push(item);
  saveState();
  renderPreview();
  clearForm(false);
};

// ==================== Edit / Delete / Undo ====================
function editQuestion(idx) {
  const q = questions[idx];
  setVal('module', q.module);
  setVal('question', q.question);
  setVal('optA', q.option[0]); setVal('optB', q.option[1]);
  setVal('optC', q.option[2]); setVal('optD', q.option[3]);
  setVal('answer', q.answer);
  setVal('solution', q.solution);
  setVal('pm', q.pm); setVal('nm', q.nm);
  // images रहने दो (फिर से अपलोड कर लेना चाहो तो)
  questions.splice(idx, 1);
  renderPreview(); saveState();
}

function deleteQuestion(idx) {
  lastDeleted = questions[idx];
  questions.splice(idx, 1);
  renderPreview(); saveState();
}

$('undoBtn').onclick = () => {
  if (lastDeleted) {
    questions.push(lastDeleted);
    renderPreview(); saveState();
    lastDeleted = null;
    alert("आखिरी डिलीट किया हुआ प्रश्न वापस आ गया!");
  } else alert("कोई डिलीट नहीं हुआ है");
};

// ==================== Preview ====================
function renderPreview() {
  const area = $('previewArea');
  area.innerHTML = '';
  if (!questions.length) {
    area.innerHTML = '<div class="muted">कोई प्रश्न नहीं जोड़ा गया।</div>';
    return;
  }

  questions.forEach((q, i) => {
    const tbl = document.createElement('table');
    tbl.className = 'preview-table';

    const rows = [
      ['Module', q.module],
      ['Q.No', q.questionno],
      ['Question', q.question, q.questionImg],
      ['A', q.option[0], q.optionImg[0]],
      ['B', q.option[1], q.optionImg[1]],
      ['C', q.option[2], q.optionImg[2]],
      ['D', q.option[3], q.optionImg[3]],
      ['Answer', q.answer],
      ['Solution', q.solution, q.solutionImg],
      ['+Marks', q.pm],
      ['-Marks', q.nm]
    ];

    rows.forEach(r => {
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.textContent = r[0];
      const td2 = document.createElement('td');
      if (r[1]) td2.innerHTML = '<div>' + r[1] + '</div>';
      if (r[2] && r[2]?.dataURL) {
        const img = document.createElement('img');
        img.src = r[2].dataURL; img.className = 'img-preview';
        td2.appendChild(img);
      }
      tr.append(td1, td2);
      tbl.appendChild(tr);
    });

    // Action buttons
    const actionTr = document.createElement('tr');
    const actionTd = document.createElement('td');
    actionTd.colSpan = 2;
    actionTd.className = 'actions';
    actionTd.innerHTML = `
      <button onclick="editQuestion(${i})" title="Edit"><i class="fas fa-edit"></i></button>
      <button onclick="deleteQuestion(${i})" title="Delete"><i class="fas fa-trash"></i></button>
    `;
    actionTr.appendChild(actionTd);
    tbl.appendChild(actionTr);

    area.appendChild(tbl);
  });
}

// ==================== JSON Import/Export ====================
$('exportJson').onclick = () => {
  if (!questions.length) return alert("कोई प्रश्न नहीं");
  const data = new Blob([JSON.stringify(questions, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(data);
  const a = document.createElement('a'); a.href = url; a.download = 'mcq_questions.json'; a.click();
  URL.revokeObjectURL(url);
};

$('importBtn').onclick = () => {
  try {
    const arr = JSON.parse($('jsonArea').value);
    if (!Array.isArray(arr)) throw "Array नहीं है";
    arr.forEach(q => { q.questionno = qno++; questions.push(q); });
    saveState(); renderPreview();
    alert(`इम्पोर्ट किया: ${arr.length} प्रश्न`);
  } catch (e) { alert("गलत JSON: " + e); }
};

\( ('clearJson').onclick = () => \)('jsonArea').value = '';
$('clearBtn').onclick = () => clearForm(true);
$('resetAll').onclick = () => {
  if (confirm('सभी प्रश्न डिलीट कर दें?')) {
    questions = []; qno = 1; lastDeleted = null; saveState(); renderPreview();
  }
};

// ==================== DOCX Export (पूरा पुराना कोड यहाँ है - काम कर रहा है) ====================
function xmlEscape(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function collectMedia(){
  const list = [];
  questions.forEach((q,i)=>{
    if(q.questionImg?.dataURL) list.push({qIndex:i, field:'questionImg', data:q.questionImg});
    q.optionImg.forEach((img,j)=>{ if(img?.dataURL) list.push({qIndex:i, field:'optionImg'+j, data:img}); });
    if(q.solutionImg?.dataURL) list.push({qIndex:i, field:'solutionImg', data:q.solutionImg});
  });
  return list;
}

function makeDrawingXml(rId,cx=4800000,cy=3200000){
  return `<w:r><w:drawing><wp:inline><wp:extent cx="\( {cx}" cy=" \){cy}"/><wp:docPr id="1" name="Pic"/><a:graphic xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"><a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture"><pic:pic xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture"><pic:blipFill><a:blip r:embed="\( {rId}" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"/><a:stretch><a:fillRect/></a:stretch></pic:blipFill><pic:spPr><a:xfrm><a:ext cx=" \){cx}" cy="${cy}"/></a:xfrm><a:prstGeom prst="rect"><a:avLst/></a:prstGeom></pic:spPr></pic:pic></a:graphicData></a:graphic></wp:inline></w:drawing></w:r>`;
}

function makeRowXml(name,value,rId,cx,cy){
  const img = rId ? `<w:p>${makeDrawingXml(rId,cx,cy)}</w:p>` : '';
  return `<w:tr><w:tc><w:p><w:r><w:t>\( {xmlEscape(name)}</w:t></w:r></w:p></w:tc><w:tc><w:p><w:r><w:t> \){xmlEscape(value)}</w:t></w:r></w:p>${img}</w:tc></w:tr>`;
}

function buildTableXml(q,rmap){
  let rows = '';
  rows += makeRowXml('Module', q.module);
  rows += makeRowXml('questionno', q.questionno);
  rows += makeRowXml('Question', q.question, rmap.questionImg, rmap.qcx, rmap.qcy);
  rows += makeRowXml('Type','mcq');
  for(let i=0;i<4;i++) rows += makeRowXml(['A','B','C','D'][i], q.option[i]||'', rmap[`optImg\( {i}`], rmap[`optCx \){i}`], rmap[`optCy${i}`]);
  rows += makeRowXml('answer', q.answer);
  rows += makeRowXml('Solution', q.solution, rmap.solImg, rmap.solCx, rmap.solCy);
  rows += makeRowXml('Positive Marks', q.pm);
  rows += makeRowXml('Negative Marks', q.nm);
  return `<w:tbl><w:tblPr><w:tblStyle w:val="TableGrid"/><w:tblW w:w="0" w:type="auto"/></w:tblPr>${rows}</w:tbl><w:p/>`;
}

function buildPackageFiles(){
  const media = collectMedia();
  const relIds = media.map((_,i)=>`rId${i+10}`);
  const rmap = questions.map(()=>({
    questionImg:null,qcx:0,qcy:0,
    optImg0:null,optCx0:0,optCy0:0,
    optImg1:null,optCx1:0,optCy1:0,
    optImg2:null,optCx2:0,optCy2:0,
    optImg3:null,optCx3:0,optCy3:0,
    solImg:null,solCx:0,solCy:0
  }));

  media.forEach((m,i)=>{
    const rid = relIds[i];
    const cx = m.field.includes('optionImg') ? 3600000 : 4800000;
    const cy = m.field.includes('optionImg') ? 2400000 : 3200000;
    if(m.field==='questionImg'){ rmap[m.qIndex].questionImg=rid; rmap[m.qIndex].qcx=cx; rmap[m.qIndex].qcy=cy; }
    else if(m.field.startsWith('optionImg')){ const n=m.field.slice(9); rmap[m.qIndex][`optImg\( {n}`]=rid; rmap[m.qIndex][`optCx \){n}`]=cx; rmap[m.qIndex][`optCy${n}`]=cy; }
    else if(m.field==='solutionImg'){ rmap[m.qIndex].solImg=rid; rmap[m.qIndex].solCx=cx; rmap[m.qIndex].solCy=cy; }
  });

  let body = '';
  questions.forEach((q,i)=> body += buildTableXml(q, rmap[i]));

  const doc = `<?xml version="1.0" encoding="UTF-8"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
            xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <w:body>${body}<w:sectPr/></w:body>
</w:document>`;

  const rels = `<?xml version="1.0"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
\( {media.map((m,i)=>`<Relationship Id=" \){relIds[i]}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/img\( {i}. \){m.data.name.split('.').pop()}"/>`).join('\n')}
</Relationships>`;

  const files = {
    "[Content_Types].xml": `<?xml version="1.0"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="xml" ContentType="application/xml"/>
<Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
\( {media.map(m=>`<Default Extension=" \){m.data.name.split('.').pop()}" ContentType="${m.data.type}"/>`).join('')}
</Types>`,
    "_rels/.rels": `<?xml version="1.0"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`,
    "word/document.xml": doc,
    "word/_rels/document.xml.rels": rels
  };

  media.forEach((m,i)=>{
    const b64 = m.data.dataURL.split(',')[1];
    const bin = atob(b64);
    const arr = new Uint8Array(bin.length);
    for(let j=0;j<bin.length;j++) arr[j] = bin.charCodeAt(j);
    files[`word/media/img\( {i}. \){m.data.name.split('.').pop()}`] = arr;
  });

  return files;
}

function buildZip(files){
  const zip = [];
  let offset = 0;
  const central = [];

  for(const name in files){
    let data = files[name];
    if(typeof data==='string') data = new TextEncoder().encode(data);
    const header = new Uint8Array(30 + name.length);
    header.set([80,75,3,4,20,0,0,0,0,0],0); // PK signature + version
    const crc = crc32(data);
    header.set([crc&255,(crc>>8)&255,(crc>>16)&255,(crc>>24)&255],14);
    header.set([data.length&255,(data.length>>8)&255,(data.length>>16)&255,(data.length>>24)&255],18);
    header.set([data.length&255,(data.length>>8)&255,(data.length>>16)&255,(data.length>>24)&255],22);
    header.set([name.length&255,(name.length>>8)&255],26);
    header.set(new TextEncoder().encode(name),30);

    zip.push(header, data);
    offset += header.length + data.length;

    const cent = new Uint8Array(46 + name.length);
    cent.set([80,75,1,2,20,0,20,0,0,0,0,0],0);
    cent.set([crc&255,(crc>>8)&255,(crc>>16)&255,(crc>>24)&255],16);
    cent.set([data.length&255,(data.length>>8)&255,(data.length>>16)&255,(data.length>>24)&255],20);
    cent.set([data.length&255,(data.length>>8)&255,(data.length>>16)&255,(data.length>>24)&255],24);
    cent.set([name.length&255,(name.length>>8)&255],28);
    cent.set([offset - data.length - header.length &255, (offset - data.length - header.length >>8)&255,
              (offset - data.length - header.length >>16)&255, (offset - data.length - header.length >>24)&255],42);
    cent.set(new TextEncoder().encode(name),46);
    central.push(cent);
  }

  const cdStart = offset;
  central.forEach(c=> { zip.push(c); offset += c.length; });

  const eocd = new Uint8Array(22);
  eocd.set([80,75,5,6,0,0,0,0],0);
  eocd.set([central.length&255,(central.length>>8)&255,central.length&255,(central.length>>8)&255],8);
  eocd.set([offset-cdStart&255,(offset-cdStart>>8)&255,(offset-cdStart>>16)&255,(offset-cdStart>>24)&255],12);
  eocd.set([cdStart&255,(cdStart>>8)&255,(cdStart>>16)&255,(cdStart>>24)&255],16);
  zip.push(eocd);

  const blob = new Blob(zip, {type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
  return blob;
}

function crc32(buf){
  let c = 0 ^ (-1);
  for(let i=0;i<buf.length;i++) c = (c>>>8) ^ crcTable[(c^buf[i])&255];
  return (c ^ (-1)) >>> 0;
}
const crcTable = (()=>{ const t=new Uint32Array(256); for(let i=0;i<256;i++){ let c=i; for(let k=0;k<8;k++) c=c&1?(0xEDB88320^(c>>>1)):c>>>1; t[i]=c; } return t; })();

$('exportBtn').onclick = () => {
  if(!questions.length) return alert("पहले कम से कम एक प्रश्न जोड़ो");
  const files = buildPackageFiles();
  const blob = buildZip(files);
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'question.docx'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),5000);
};

// ==================== Start ====================
renderPreview();
</script>
</body>
</html>

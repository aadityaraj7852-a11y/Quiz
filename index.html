<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Current Affairs Builder</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{font-family:Arial;margin:20px;background:#f2f2f2;}
.card{background:#fff;border:1px solid #ccc;padding:12px;margin-bottom:12px;border-radius:8px;}
h2{margin-bottom:5px}
input,textarea,select{width:100%;padding:7px;border:1px solid #aaa;border-radius:6px;margin:6px 0}
.icon{cursor:pointer;font-size:17px;margin-right:10px;color:#000}
label{font-weight:bold}
.img-prev{max-width:260px;margin-top:8px;border:1px solid #999}
.btn{background:#222;color:#fff;padding:7px 14px;border-radius:6px;border:0;margin-top:6px;cursor:pointer}
</style>
</head>

<body>

<h2>Current Affairs Builder (Full Version)</h2>

<label>Categories</label>
<input id="cat">

<label>States</label>
<input id="state">

<label>Language (hi/en)</label>
<input id="lang">

<label>Title</label>
<textarea id="title"></textarea>

<label>Banner Image</label>
<input type="file" id="banner">

<label>Body</label>
<textarea id="bodyText" rows="5"></textarea>

<button class="btn" onclick="addItem()">Add Entry</button>

<hr>

<h3>Preview</h3>
<div id="list"></div>

<button class="btn" onclick="exportDocx()">Export DOCX</button>

<script>
// STATE
let items = [];
function $(id){return document.getElementById(id)}

function readFile(i){
  return new Promise(res=>{
    const f=i.files && i.files[0];
    if(!f) return res(null);
    const r=new FileReader();
    r.onload=()=>res({name:f.name,type:f.type,dataURL:r.result});
    r.readAsDataURL(f);
  });
}

// FREE GOOGLE TRANSLATE
async function translateFree(t){
  let url=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=hi&tl=en&dt=t&q=${encodeURIComponent(t)}`;
  let r=await fetch(url);
  let j=await r.json();
  return j[0].map(x=>x[0]).join("");
}

// ADD ITEM
async function addItem(){
  let cat=$('cat').value.trim();
  let st=$('state').value.trim();
  let ln=$('lang').value.trim();
  let tt=$('title').value.trim();
  let bd=$('bodyText').value.trim();

  if(!tt||!bd){alert("Title/Body required");return;}

  let img=await readFile($('banner'));

  let enTitle="", enBody="";

  if(ln==="hi"){
    enTitle = await translateFree(tt);
    enBody = await translateFree(bd);
  } else {
    enTitle = tt;
    enBody = bd;
  }

  let it={
    id:Date.now(),
    categories:cat,
    states:st,
    lang:ln,
    title:tt,
    banner:img,
    body:bd,
    enTitle,
    enBody
  };

  items.push(it);
  render();
}

function render(){
  let box=$('list');
  box.innerHTML="";
  items.forEach(it=>{
    let c=document.createElement("div");
    c.className="card";

    c.innerHTML=
    `<div>
      <b>Categories:</b> ${it.categories}<br>
      <b>States:</b> ${it.states}<br>
      <b>Lang:</b> ${it.lang}<br><br>
      <b>Title:</b> ${it.title}<br><br>
      <b>Body:</b> ${it.body.slice(0,120)}...<br><br>

      <i class="fa fa-edit icon" onclick="editItem(${it.id})"></i>
      <i class="fa fa-trash icon" onclick="delItem(${it.id})"></i>
    </div>`;

    if(it.banner){
      let im=document.createElement("img");
      im.src=it.banner.dataURL;
      im.className="img-prev";
      c.appendChild(im);
    }

    box.appendChild(c);
  });
}

function delItem(id){
  items = items.filter(x=>x.id!==id);
  render();
}

function editItem(id){
  let x = items.find(a=>a.id===id);
  if(!x)return;

  $('cat').value=x.categories;
  $('state').value=x.states;
  $('lang').value=x.lang;
  $('title').value=x.title;
  $('bodyText').value=x.body;

  delItem(id);
}

// ---------------- DOCX EXPORT ----------------
function xmlEsc(s){
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function imgXML(rId,cx=5000000,cy=3000000){
return `<w:p>
<w:r>
<w:drawing>
<wp:inline xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing">
<wp:extent cx="${cx}" cy="${cy}"/>
<wp:docPr id="1" name="img"/>
<a:graphic xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main">
<a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture">
<pic:pic xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">
<pic:nvPicPr><pic:cNvPr id="0" name="pic"/><pic:cNvPicPr/></pic:nvPicPr>
<pic:blipFill><a:blip xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" r:embed="${rId}"/><a:stretch><a:fillRect/></a:stretch></pic:blipFill>
<pic:spPr><a:xfrm><a:off x="0" y="0"/><a:ext cx="${cx}" cy="${cy}"/></a:xfrm></pic:spPr>
</pic:pic>
</a:graphicData>
</a:graphic>
</wp:inline>
</w:drawing>
</w:r>
</w:p>`;
}

async function exportDocx(){
  // build DOCX file
  let media=[], rel=[], body="";

  let idx=1;

  for(let it of items){

    // Hindi block
    body+=`<w:p><w:r><w:t>###currentAffair</w:t></w:r></w:p>`;
    body+=`<w:p><w:r><w:t>currentAffair</w:t></w:r></w:p>`;

    body+=`<w:p><w:r><w:t>###categories</w:t></w:r></w:p>`;
    body+=`<w:p><w:r><w:t>${xmlEsc(it.categories)}</w:t></w:r></w:p>`;

    body+=`<w:p><w:r><w:t>###states</w:t></w:r></w:p>`;
    body+=`<w:p><w:r><w	t>${xmlEsc(it.states)}</w:t></w:r></w:p>`;

    body+=`<w:p><w:r><w:t>###lang</w:t></w:r></w:p>`;
    body+=`<w:p><w:r><w:t>hi</w:t></w:r></w:p>`;

    body+=`<w:p><w:r><w:t>###title</w:t></w:r></w:p>`;
    body+=`<w:p><w:r><w:t>${xmlEsc(it.title)}</w:t></w:r></w:p>`;

    body+=`<w:p><w:r><w:t>###banner</w:t></w	r></w:p>`;
    body+=`<w:p></w:p>`;

    let imgId=null;
    if(it.banner){
      imgId="rId"+idx;
      let b64=it.banner.dataURL.split(",")[1];
      media.push({id:imgId,b64});
      idx++;
      body+=imgXML(imgId);
    }

    body+=`<w:p><w:r><w:t>###body</w:t></w:r></w:p>`;
    body+=`<w:p><w:r><w:t>${xmlEsc(it.body)}</w:t></w:r></w:p>`;

    // EN block
    body+=`<w:p><w:r><w:t>###currentAffair</w:t></w:r></w:p>`;
    body+=`<w:p><w:r><w:t>currentAffair</w:t></w:r></w	p>`;

    body+=`<w:p><w:r><w:t>###categories</w:t></w:r></w	p>`;
    body+=`<w:p><w:r><w:t>${xmlEsc(it.categories)}</w:t></w:r></w	p>`;

    body+=`<w:p><w:r><w:t>###states</w:t></w	r></w:p>`;
    body+=`<w:p><w:r><w:t>${xmlEsc(it.states)}</w:t></w:r></w	p>`;

    body+=`<w:p><w:r><w:t>###lang</w:t></w:r></w	p>`;
    body+=`<w:p><w:r><w:t>en</w:t></w:r></w	p>`;

    body+=`<w:p><w:r><w:t>###title</w:t></w:r></w	p>`;
    body+=`<w:p><w:r><w:t>${xmlEsc(it.enTitle)}</w:t></w:r></w	p>`;

    body+=`<w:p><w:r><w:t>###banner</w:t></w:r></w	p>`;
    body+=`<w:p></w:p>`;
    if(imgId) body+=imgXML(imgId);

    body+=`<w:p><w:r><w:t>###body</w:t></w:r></w	p>`;
    body+=`<w:p><w:r><w:t>${xmlEsc(it.enBody)}</w:t></w:r></w	p>`;
  }

  // DOCX package
  let docXML=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
  xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
  xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
  xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"
  xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">
  <w:body>${body}<w:sectPr/></w:body></w:document>`;

  let rels=`<?xml version="1.0"?>
  <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
  </Relationships>`;

  let docRels=`<?xml version="1.0"?>
  <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  </Relationships>`;

  media.forEach(m=>{
    docRels = docRels.replace("</Relationships>",
      `<Relationship Id="${m.id}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/${m.id}.png"/></Relationships>`
    );
  });

  let types=`<?xml version="1.0"?>
  <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Default Extension="png" ContentType="image/png"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
  </Types>`;

  // ZIP BUILD
  function str(s){return new TextEncoder().encode(s)}
  let zip={};

  zip["[Content_Types].xml"]=str(types);
  zip["_rels/.rels"]=str(rels);
  zip["word/document.xml"]=str(docXML);
  zip["word/_rels/document.xml.rels"]=str(docRels);

  media.forEach(m=>{
    zip[`word/media/${m.id}.png`]=Uint8Array.from(atob(m.b64),c=>c.charCodeAt(0));
  });

  let blob=makeZip(zip);
  let url=URL.createObjectURL(blob);
  let a=document.createElement("a");
  a.href=url;
  a.download="current_affairs.docx";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url),2000);
}

// ZIP MAKER
function makeZip(files){
  function u32(n){return [n&255,(n>>8)&255,(n>>16)&255,(n>>24)&255]}
  function crc32(a){let c=-1;for(let i=0;i<a.length;i++){c=c>>>8^t[(c^a[i])&255]}return(c^-1)>>>0}
  let t=new Uint32Array(256);for(let n=0;n<256;n++){let c=n;for(let k=0;k<8;k++)c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1);t[n]=c>>>0}
  let lf=[],cf=[],offs=0;

  for(let name in files){
    let data=files[name];
    let f=str(name);
    let crc=crc32(data);
    let cs=data.length,us=data.length;

    let lh=new Uint8Array(30+f.length);
    lh.set([80,75,3,4,20,0,0,0,0,0],0);
    lh.set(u32(crc),14);
    lh.set(u32(cs),18);
    lh.set(u32(us),22);
    lh[26]=f.length&255;lh[27]=f.length>>8;
    lh.set(f,30);
    lf.push({h:lh,d:data});

    let ch=new Uint8Array(46+f.length);
    ch.set([80,75,1,2,20,0,20,0],0);
    ch.set(u32(crc),16);
    ch.set(u32(cs),20);
    ch.set	u32(us),24);
    ch[28]=f.length&255;ch[29]=f.length>>8;
    ch.set(u32(offs),42);
    ch.set(f,46);
    cf.push(ch);

    offs+=lh.length+data.length;
  }

  let cl=0;cf.forEach(c=>cl+=c.length);
  let ol=offs+cl+22;
  let out=new Uint8Array(ol);
  let p=0;
  lf.forEach(x=>{out.set(x.h,p);p+=x.h.length;out.set(x.d,p);p+=x.d.length});
  let cd=p;
  cf.forEach(c=>{out.set(c,p);p+=c.length});
  out.set([80,75,5,6,0,0,0,0],p);p+=8;
  out.set(u32(cf.length),p);p+=2;
  out.set(u32(cf.length),p);p+=2;
  out.set(u32(cl),p);p+=4;
  out.set(u32(cd),p);p+=4;
  return new Blob([out],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
}

</script>
</body>
</html>
